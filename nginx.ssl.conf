#=========================================================================#
# Default Web Domain Template                                             #
# DO NOT MODIFY THIS FILE! CHANGES WILL BE LOST WHEN REBUILDING DOMAINS   #
# https://hestiacp.com/docs/server-administration/web-templates.html      #
#=========================================================================#

server {
        listen      51.75.126.183:443 ssl;
        server_name rtfm2win.ovh www.rtfm2win.ovh;
        root        /home/laurent/web/rtfm2win.ovh/public_html/public;
        index       index.php index.html index.htm;
        access_log  /var/log/nginx/domains/rtfm2win.ovh.log combined;
        access_log  /var/log/nginx/domains/rtfm2win.ovh.bytes bytes;
        error_log   /var/log/nginx/domains/rtfm2win.ovh.error.log error;

        ssl_certificate     /home/laurent/conf/web/rtfm2win.ovh/ssl/rtfm2win.ovh.pem;
        ssl_certificate_key /home/laurent/conf/web/rtfm2win.ovh/ssl/rtfm2win.ovh.key;
        ssl_stapling        on;
        ssl_stapling_verify on;

        # TLS 1.3 0-RTT anti-replay
        if ($anti_replay = 307) { return 307 https://$host$request_uri; }
        if ($anti_replay = 425) { return 425; }

        include /home/laurent/conf/web/rtfm2win.ovh/nginx.hsts.conf*;

        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }

        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }

        location ~ /\.(?!well-known\/) {
                deny all;
                return 404;
        }

        # Laravel routing - IMPORTANT: utilise $query_string au lieu de $args
        location / {
                try_files $uri $uri/ /index.php?$query_string;

                # Assets statiques avec cache optimisé
                location ~* ^.+\.(ogg|ogv|svg|svgz|swf|eot|otf|woff|woff2|mov|mp3|mp4|webm|flv|ttf|rss|atom|jpg|jpeg|gif|png|webp|ico|bmp|mid|midi|wav|rtf|css|js|jar)$ {
                        expires 1y;
                        add_header Cache-Control "public, immutable";
                        fastcgi_hide_header "Set-Cookie";
                }

                # Livewire (si utilisé)
                location = /livewire/livewire.js {
                        expires off;
                        try_files $uri $uri/ /index.php?$query_string;
                }
                location = /livewire/livewire.min.js {
                        expires off;
                        try_files $uri $uri/ /index.php?$query_string;
                }

                # Configuration PHP optimisée pour Laravel
                location ~ [^/]\.php(/|$) {
                        try_files $uri =404;

                        include /etc/nginx/fastcgi_params;

                        fastcgi_index index.php;
                        fastcgi_param HTTP_EARLY_DATA $rfc_early_data if_not_empty;
                        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                        
                        # Optimisations PHP-FPM pour Laravel
                        fastcgi_read_timeout 300;
                        fastcgi_buffer_size 128k;
                        fastcgi_buffers 4 256k;

                        fastcgi_pass unix:/run/php/php8.3-fpm-rtfm2win.ovh.sock;

                        include /home/laurent/conf/web/rtfm2win.ovh/nginx.fastcgi_cache.conf*;
                }
        }

        # Sécurité Laravel - Bloquer l'accès aux fichiers sensibles
        location ~ /\.(env|git) {
                deny all;
                return 404;
        }

        location ~ ^/(storage|bootstrap/cache) {
                deny all;
                return 404;
        }

        location /error/ {
                alias /home/laurent/web/rtfm2win.ovh/document_errors/;
        }

        location /vstats/ {
                alias   /home/laurent/web/rtfm2win.ovh/stats/;
                include /home/laurent/web/rtfm2win.ovh/stats/auth.conf*;
        }

        proxy_hide_header Upgrade;

        include /etc/nginx/conf.d/phpmyadmin.inc*;
        include /etc/nginx/conf.d/phppgadmin.inc*;
        include /home/laurent/conf/web/rtfm2win.ovh/nginx.ssl.conf_*;
}
        